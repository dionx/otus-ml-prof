# Домашнее задание

Классификация облаков

**Цель:**

Неглубокие облака играют огромную роль в определении климата Земли, но их трудно распознать и классифицировать в климатических моделях. Классифицируя различные типы организации облаков, исследователи из Института Макса Планка надеются улучшить наше физическое понимание этих облаков, что, в свою очередь, поможет нам построить более совершенные климатические модели.

Существует множество способов организации облаков, но границы между различными формами организации нечеткие. Это затрудняет построение традиционных алгоритмов, основанных на правилах, для разделения облачных характеристик. Однако человеческий глаз отлично справляется с обнаружением особенностей - например, облаков, похожих на цветы.

В этом задании вам предстоит построить модель для классификации моделей организации облаков на спутниковых снимках. В случае успеха вы поможете ученым лучше понять, как облака будут определять наш будущий климат.

**Описание/Пошаговая инструкция выполнения домашнего задания:**

* сформировать нейронную сверточную сеть;
* обучить сеть на представленных данных;
* оценить качество модели. В качестве критерия используйте Dice coefficient.
* датасет для обучения модели: https://www.kaggle.com/competitions/understanding_cloud_organization/data

**Links**

* https://www.kaggle.com/code/solmazmohammadi/cloud-segmentation
* https://www.kaggle.com/code/volkanastasia/understanding-clouds-creating-the-mask
* https://www.kaggle.com/competitions/understanding_cloud_organization/writeups/andrey-kiryasov-2nd-place-solution
* https://medium.com/%40keur.plkar/kaggle-competition-understanding-clouds-from-satellite-images-creating-segmentation-label-masks-b7cb6666e750
* https://www.kaggle.com/code/cdeotte/unsupervised-masks-cv-0-60
* https://neerc.ifmo.ru/wiki/index.php?title=%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B0_%D0%BD%D0%B0%D1%85%D0%BE%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2_%D0%BD%D0%B0_%D0%B8%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B8


**Q&A**

Q: Спасибо. Я правильно понимаю, что нам нужно предсказать категорию, а не построить маску сегментации?

A: Да в целом задача состоит в классификации изображений. EncodedPixels использует кодирование длин серий для значений пикселей, относящихся к различным типам облачного покрова, в виде пары значений, содержащие начальную позицию и длину серии. Например, «1 3» означает, что нужно начать с пикселя 1 и пройти в общей сложности 3 пикселя (1, 2, 3). Формат соревнования требует, чтобы пары были разделены пробелами. Например, «1 3 10 5» означает, что в маску нужно включить пиксели 1, 2, 3, 10, 11, 12, 13, 14. Пары отсортированы, являются положительными и что декодированные значения пикселей не повторяются. Пиксели нумеруются сверху вниз, а затем слева направо: 1 – это пиксель (1,1), 2 – пиксель (2,1) и т. д.
 
Но для того, чтобы классификатор понял какой тип облаков Вы детектируете, нужно указанную маску применить к изображению, оставив только пиксели с облачным покровом, соответствующем маске и на этих изображениях учить модель.
 
Для реальных изображений нам также нужна маска – мы просто можем ее создать, например, по пороговому значению (светлые объекты от 150 до 250 по яркости пикселей), а затем разобрать по пикселям. При этом можно потренировтаься создавать такие фильтры на изображениях по которым уже есть размеченная маска и сравнивать качество нашей маскировки с помощью Dice coefficient:
 
Пример создания маски: https://www.kaggle.com/code/volkanastasia/understanding-clouds-creating-the-mask


Q: Переформулирую вопрос. Что должна выдать сеть в итоге? 4 маски или 4 вероятности для каждого класса?
Просто  "В качестве критерия используйте Dice coefficient." намекает на то, что мы должны получить 4 маски

A: 4 класса, но для извлечения признаков из каждого изображения нужны маски


Q: А зачем тогда Dice использовать? Почему не стадартные метрики для классификации?

A: Нам нужно предсказать контуры четырех типов облаков (Fish, Flower, Gravel, Sugar) на спутниковых снимках. Эти структуры часто имеют сложную, прерывистую, "кружевную" форму, а не единые объекты.
Ключевая проблема: Облака одного типа могут быть разбросаны по всему изображению в виде множества мелких скоплений. Метрика должна быть чувствительна к качеству предсказания формы каждого маленького сегмента, а не просто к положению объекта в целом.
Низкая чувствительность к классовому дисбалансу (внутри изображения), т.е. если на снимке огромная площадь это "фон" (небо/океан), и лишь небольшая часть — целевые облака. Dice сравнивает только пересечение и объединение предсказанных и истинных масок, игнорируя обширные области истинного фона, которые были корректно классифицированы как фон.


Q: К сожалению тема вообще не была затронута на лекции, поэтому буду зануден.
Т.е. сеть должна выдать 4х канальную маску, где каждый канал - маска для отдельного типа облаков?

A: Подробнее: нейросеть должна предсказывать пиксельную маску (segmentation mask) для четырех классов облаков на спутниковых снимках, т.е. на выходе модель должна предсказать для каждого из четырех классов облаков бинарную маску того же размера, что и входное изображение. В этой маске 1 (или 255) обозначает пиксели, где присутствует облако данного типа, а 0 — где его нет.  На одном изображении могут присутствовать несколько типов облаков одновременно, а может не быть ни одного. 
Предсказания затем пороговым методом (надо еще подумать как подобрать порог) превращаются в бинарные маски. Модель "раскрасит" пиксели, соответствующие четырем разным паттернам облаков, чтобы итоговый Dice coefficient между вашими масками и истинными был максимальным.
